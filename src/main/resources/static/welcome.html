<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>
        监控首页
    </title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <link rel="stylesheet" href="css/main.css" media="all">
    <link rel="stylesheet" href="lib/bootstrap/css/bootstrap.css" media="all">
    <!--导入ElementUI样式列表，css样式一般都在页面头部-->
    <link rel="stylesheet" href="css/index.css">
    <!--分页 pagination样式-->
    <link rel="stylesheet" href="css/pagination.css">
</head>
<body onload="initMenu();">
<style type="text/css">
    legend {
        display: block;
        width: 100px;
        border-bottom: 0px;
        font-family: "Microsoft YaHei", "Helvetica Neue";
    }

    legend a {
        color: #666;
    }

    legend a:hover {
        text-decoration: none;
    }

    .layui-table {
        font-family: "Microsoft YaHei", "Helvetica Neue";
    }

    canvas {
        width: 100%;
        height: 100%;
        border-radius: 4px;
    }

    .player1 {
        width: 80%;
        /*width: 960px;*/
        /*height: 540px;*/
        /*float: left;*/
        margin-left: 8%;
        /*margin-top: 30px;*/
    }

    .player4 {
        width: 40%;
        /*width: 480px;*/
        /* height: 270px; */
        /* float: left; */
        margin-left: 5%;
        /* margin-top: 20px;*/
        display: inline-block;
    }

    .player9 {
        width: 25%;
        /*width: 320px;*/
        /* height: 180px; */
        /* float: left; */
        margin-left: 6%;
        /* margin-top: 20px;*/
        display: inline-block;
    }

    .divMachineName {
        position: absolute;
        margin-left: 10px;
        margin-top: 5px;
        color: white;
    }

</style>
<!--<blockquote class="layui-elem-quote" style="margin-top: 20px;margin-left: 15px">-->
<!--    欢迎使用气体遥测监测预警系统！-->
<!--    &lt;!&ndash;        <span class="f-14">v1.0</span> &nbsp;&nbsp;登录次数：520&ndash;&gt;-->
<!--</blockquote>-->
<div id="radioDiv">
    <label style="margin-left: 15px;margin-top: 10px">视频:</label>
    <label>
        <input type="radio" name="videoType" value="VI" checked='checked'>可见光
    </label>
    <label>
        <input type="radio" name="videoType" value="IR">红外
    </label>
</div>

<div class="x-body" style="padding: 0px;border-radius: 0px;">
    <div id="video_back" style="padding-top: 1%;">
    </div>
</div>
<div class="x-body" style="height: 200px;border-radius: 0px">
    <button class="layui-btn layui-btn-danger" onclick="playBtn(1)">1个画面</button>
    <button class="layui-btn layui-btn-danger" onclick="playBtn(4)">4个画面</button>
    <button class="layui-btn layui-btn-danger" onclick="playBtn(9)">9个画面</button>

    <div id="pagination-box" style="margin-top: 50px;margin-right:80px;float: right;">
        <ul id="pagination-ul">
        </ul>
    </div>
</div>


<div class="col-md-12"></div>

<script src="lib/layui/layui.js" charset="utf-8"></script>
<!--Vue js脚本-->
<script src="js/vue.js" charset="utf-8"></script>
<!--引入ElementUI组件库-->
<script src="js/index.js" charset="utf-8"></script>
<!--引入Axios js脚本-->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!--引入时间插件包Momentjs-->
<script src="js/moment.min.js" charset="utf-8"></script>
<script src="js/jquery.min.js"></script>
<script src="js/echarts.min.js"></script>
<script type="text/javascript" src="js/Decoder.js"></script>
<script type="text/javascript" src="js/YUVCanvas.js"></script>
<script type="text/javascript" src="js/Player.js"></script>
<script type="text/javascript" src="url.js"></script>

<script type="text/javascript">
    var videoType = "VI";

    // radio添加事件监听，切换视频模式时执行
    var videoTypeArr = document.getElementsByName("videoType");
    videoTypeArr[0].onclick = function () {
        videoType = videoTypeArr[0].value;
        generateCanvas(false, id);
    };
    videoTypeArr[1].onclick = function () {
        videoType = videoTypeArr[1].value;
        generateCanvas(false, id);
    };

    // 从导航菜单进入播放页时传入设备的id。用于判定后续切换视频模式时是否根据id加载
    // 从Pagination进入播放，从Btn进入播放时，会清空id
    var id = "";

    //设备url只维护单纯的ip地址，ws前缀和ws端口号用默认的
    var urlTemplate = "ws://ip:7250/";

    var pageNum = 1;
    var pageSize = 1;
    var totalCount = 0;

    var playerMap = {};
    var clientMap = {};

    //从Pagination进入播放，pageNum根据传入参数确定，pageSize不变，将id清空
    function playPagination(num) {
        id = "";
        pageNum = num;
        generateCanvas(false, "");
    }

    //从Btn进入播放，pageNum置为1，pageSize根据传入参数确定1/4/9宫格，将id清空
    function playBtn(size) {
        id = "";
        pageNum = 1;
        pageSize = size;
        generateCanvas(true, "");
    }

    //从菜单进入播放，pageNum默认为1，pageSize默认为1，但是会传入设备id
    function playMenu(id) {
        generateCanvas(true, id);
    }

    function generateCanvas(initPaginationFlag, id) {
        console.log("show " + pageSize + " canvas!");

        let path = "";
        let jsonObject = {};

        if (id === "") {
            path = apiPath + "/machine/search";
            jsonObject = {
                "pageNum": pageNum,
                "pageSize": pageSize
            };
        } else {
            path = apiPath + "/machine/searchOneList"
            jsonObject = {
                "id": id
            };
        }

        axios.post(path, jsonObject).then((res) => {
            console.log("获取监测设备list:");
            console.log(res.data.data);
            let machineList = res.data.data;

            totalCount = res.data.total;
            //判断是否重新绘制分页插件(从Btn进入需要重新绘制，从Pagination进入不需要)
            if (initPaginationFlag) {
                initPagination();
            }

            let parent = document.getElementById("video_back");
            parent.innerHTML = '';
            for (let key in playerMap) {
                let prePlayer = playerMap[key];
                let preClient = clientMap[key];
                preClient.close();
                preClient = null;
                prePlayer = null;
            }
            playerMap = {};
            clientMap = {};

            for (let i = 0; i < machineList.length; i++) {
                let machine = machineList[i];
                let machineId = machine.id;

                // 包含播放器的div id为设备id class根据pageSize决定
                let div = document.createElement("div");
                div.id = machineId;
                div.className = getCanvasDivStyle(pageSize);

                // 设备名称标签
                let divMachineName = document.createElement("div");
                divMachineName.innerText = machine.machineName;
                divMachineName.className = "divMachineName";
                div.appendChild(divMachineName);

                // canvas播放器
                let player = new Player();
                let canvas = player.canvas;
                if(videoType === "VI"){
                    canvas.width = 1280;
                    canvas.height = 720;
                }
                if(videoType === "IR"){
                    canvas.width = 640;
                    canvas.height = 512;
                }
                div.appendChild(canvas);

                // 将包含播放器的div加入到父div中
                parent.appendChild(div);

                // 维护播放器对象、websocket连接对象
                let machineUrl = machine.machineUrl;
                try {
                    let websocketClient = new WebSocket(urlTemplate.replace("ip", machineUrl));
                    playerMap[machineId] = player;
                    clientMap[machineId] = websocketClient;
                } catch (e) {
                    console.log(e)
                }
            }

            for (let key in playerMap) {
                let canvasPlayer = playerMap[key];
                let client = clientMap[key];
                client.binaryType = 'arraybuffer';
                client.onopen = function (evt) {
                    // alert("open");
                };
                client.onclose = function (evt) {
                    console.log("websocket connection closed!");
                    client.close();
                };
                client.onerror = function (evt) {
                    console.log("websocket connect error!");
                    // alert("websocket connection error!");
                };
                client.onmessage = function (evt) {
                    var b = evt.data;
                    var tag_msg = b.split('$');
                    if (tag_msg.length == 4 && tag_msg[1] == "WVideoX264VI") {
                        var tag_1 = jQuery.parseJSON(tag_msg[3]);
                        //var tag_2 = ;
                        let decode = window.atob(tag_1['Msg']['VideoData']);
                        var len = decode.length;
                        var bytes_1 = new Uint8Array(len);
                        for (var i = 0; i < len; i++) {
                            bytes_1[i] = decode.charCodeAt(i);
                        }
                        canvasPlayer.decode(bytes_1);
                    } else {
                        if (b == "you are connected!") {
                            console.log(b);
                            var scrible_msg =
                                'create_subscriber$WVideoX264' + videoType + '$G2021001${"Msg":{"TopicName":"WVideoX264' + videoType + '","TopicDomain":"1001","TopicSource":"G2021001"},"TimeStamp":"20210220214742"}';
                            client.send(scrible_msg);
                        }
                    }
                };
            }
        });

    }

    function getCanvasDivStyle(pageSize) {
        if (pageSize === 1) {
            return "player1";
        } else if (pageSize > 1 && pageSize <= 4) {
            return "player4";
        } else if (pageSize > 4) {
            return "player9";
        }
    }

    function initPagination() {
        let paginationUlEvent = document.getElementById("pagination-ul");
        paginationUlEvent.innerHTML = '';
        let leftButton = document.createElement("button");
        let rightButton = document.createElement("button");
        let leftIcon = document.createElement("i");
        let rightIcon = document.createElement("i");
        let clickIndex = 0;

        leftButton.id = "pagination-btn-left";
        leftButton.style.cursor = "not-allowed";
        leftButton.appendChild(leftIcon);
        paginationUlEvent.appendChild(leftButton);

        let totalPageNum = pageTotal();
        for (let j = 1; j < totalPageNum + 1; j++) {
            let li = document.createElement("li");
            let a = document.createElement("a");
            if (j === 1) {
                li.className = "li-checked";
                a.className = "a-checked";
            }
            a.innerHTML = j;
            li.appendChild(a);
            paginationUlEvent.appendChild(li);
        }

        rightButton.id = "pagination-btn-right";
        rightButton.className = "isSelect";
        rightButton.style.cursor = "pointer";
        rightButton.appendChild(rightIcon);
        paginationUlEvent.appendChild(rightButton);


        let liEvent = document.getElementsByTagName("li");
        let aEvent = document.getElementsByTagName("a");
        for (let i = 0; i < liEvent.length; i++) {
            liEvent[i].onclick = function (e) {
                removeCheckedClass();
                liEvent[i].className = "li-checked";
                aEvent[i].className = "a-checked";
                clickIndex = i;
                //展示选定页数据
                playPagination(i + 1);
                console.log("pageNum:" + (i + 1));
                switch (i) {
                    case 0: {
                        leftButton.style.cursor = "not-allowed";
                        rightButton.style.cursor = "pointer";
                        leftButton.className = "noSelect";
                        rightButton.className = "isSelect";
                    }
                        break;
                    case (liEvent.length - 1): {
                        leftButton.style.cursor = "pointer";
                        rightButton.style.cursor = "not-allowed";
                        leftButton.className = "isSelect";
                        rightButton.className = "noSelect";
                    }
                        break;
                    default: {
                        leftButton.style.cursor = "pointer";
                        rightButton.style.cursor = "pointer";
                        leftButton.className = "isSelect";
                        rightButton.className = "isSelect";
                    }
                }
            }
        }

        function pageTotal() {
            if (pageSize !== 0 && totalCount % pageSize === 0) {
                return totalCount / pageSize
            } else if (pageSize !== 0 && totalCount % pageSize !== 0) {
                return Math.ceil(totalCount / pageSize);
            } else return 0;
        }

        function removeCheckedClass() {
            for (let i = 0; i < liEvent.length; i++) {
                if (liEvent[i].className == "li-checked") {
                    liEvent[i].className = "";
                    aEvent[i].className = "";
                }
            }
        }

        function clickButtonEvent(i) {
            //展示上一页/下一页数据
            playPagination(i + 1);
            console.log("pageNum:" + (i + 1));
            removeCheckedClass();
            liEvent[i].className = "li-checked";
            aEvent[i].className = "a-checked";
            clickIndex = i;
            switch (i) {
                case 0: {
                    leftButton.style.cursor = "not-allowed";
                    rightButton.style.cursor = "pointer";
                    leftButton.className = "noSelect";
                    rightButton.className = "isSelect";
                }
                    break;
                case (liEvent.length - 1): {
                    leftButton.style.cursor = "pointer";
                    rightButton.style.cursor = "not-allowed";
                    leftButton.className = "isSelect";
                    rightButton.className = "noSelect";
                }
                    break;
                default: {
                    leftButton.style.cursor = "pointer";
                    rightButton.style.cursor = "pointer";
                    leftButton.className = "isSelect";
                    rightButton.className = "isSelect";
                }
            }
        }

        leftButton.onclick = function () {
            console.log(leftButton.style)
            if (leftButton.style.cursor == "not-allowed") {
                return false;
            } else if (leftButton.style.cursor == "pointer") {
                if (clickIndex <= 0) {
                    return false;
                } else {
                    let index = clickIndex - 1;
                    clickButtonEvent(index);
                }
            }
        }

        rightButton.onclick = function () {
            if (rightButton.style.cursor == "not-allowed") {
                return false;
            } else if (rightButton.style.cursor == "pointer") {
                if (clickIndex >= liEvent.length - 1) {
                    return false;
                } else {
                    let index = clickIndex + 1;
                    clickButtonEvent(index);
                }
            }
        }

    }

    function initMenu() {
        id = getQueryVariable("id");
        console.log("id:" + id);

        playMenu(id);
    }

    function getQueryVariable(variable) {
        let query = window.location.search.substring(1);
        let vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            let pair = vars[i].split("=");
            if (pair[0] == variable) {
                return pair[1];
            }
        }
        return false;
    }
</script>

<script type="text/javascript">
    //修改元素的css属性
    // var chi = $("#div01").children();
    // chi.css("width","480px");
    // chi.css("height","270px");
</script>

</body>
</html>