<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Beid - Responsive HTML5 Template</title>

    <!-- CSS -->
    <link href="css/fonts/fontawesome/all.min.css" rel="stylesheet">
    <link href="css/fonts/beid.css" rel="stylesheet">

    <link href="css/main.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">

    <!-- JQVMAP -->
    <link href="plugins/jqvmap/jqvmap.min.css" rel="stylesheet">

    <!-- dateRangePicker -->
    <link href="plugins/daterangepicker/daterangepicker.css" rel="stylesheet">

    <!-- Favicons -->
    <link rel="apple-touch-icon" href="img/apple-touch-icon.png">
    <link rel="icon" href="img/favicon.png">

    <!-- Fonts -->
    <link href="fonts/inter/inter.css" rel="stylesheet">

    <link rel="stylesheet" href="plugins/elementUI/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="css/pagination.css">

    <script crossorigin="anonymous" src="js/axios.js"></script>

    <script src="js/logout.js"></script>
    <script src="js/time.js"></script>
    <script src="js/welcome.js"></script>
    <script src="url.js"></script>
    <script src="js/auth.js"></script>

    <!-- import layui CSS -->
    <link rel="stylesheet" href="plugins/layui/css/layui.css">
    <!-- 查看图片 -->
    <link rel="stylesheet" href="css/imageBox.css">

    <style>
        .canvas {
            width: 100%;
        }

        .table {
            text-align: left;
            border-bottom: 0px solid rgba(255, 255, 255, 0.15);
            color: white;

            table-layout: fixed;
        }

        .table td {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .table thead th {
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

    </style>
</head>

<body class="body" background="img/bg1.png">

<div class="main-container" style="">
    <div class="overflow-hidden" style="">
        <div id="card" class="page-content-fl">
            <div class="row flex-wrap align-items-center px-6 py-5" style="border-bottom: 0 solid rgba(42, 242, 112, 0.2);">
                <div class="col">
                    <div class="d-flex align-items-center">
<!--                        隐藏视频模式切换按钮，同时将外层的容器格式由-->
<!--                        border-bottom: 1px solid rgba(42, 242, 112, 0.2);-->
<!--                        改为-->
<!--                        border-bottom: 0 solid rgba(42, 242, 112, 0.2);-->
<!--                        <div class="mr-2">-->
<!--                            <label class="mb-0">可见光</label>-->
<!--                        </div>-->
<!--                        <div class="custom-switch custom-switch-outline">-->
<!--                            <input type="checkbox" class="custom-switch-input" id="switchOutline-fie" onclick="changeVideoType()">-->
<!--                            <label class="custom-switch-label" for="switchOutline-fie"></label>-->
<!--                        </div>-->
<!--                        <div class="ml-2">-->
<!--                            <label class="mb-0">红外</label>-->
<!--                        </div>-->
                    </div>
                </div>

                <div id="pagination-box">
                    <ul id="pagination-ul" style="margin-bottom: -0.18rem">
                    </ul>
                </div>
                <div class="col-12 col-lg-auto">
                    <a class="el-icon-s-platform" onclick="playBtn(1)" style="font-size: 25px; color:white;cursor:pointer" title="1个画面"></a>
                    <a class="el-icon-menu" onclick="playBtn(4)" style="font-size: 25px; color:white;cursor:pointer" title="4个画面"></a>
                    <a class="el-icon-s-grid" onclick="playBtn(9)" style="font-size: 25px; color:white;cursor:pointer" title="9个画面"></a>
                </div>
            </div>

            <div class="container-fluid p-0">
                <div class="row panel-top-line">
                    <div class="col">
                        <div class="py-7">
                            <div>
                                <div id="video_back" class="panel-row row no-gutters justify-content-center">
                                    <!--                                        <div class="panel-col col-md-4" style="border: 1px solid rgba(42, 242, 112, 0.2);">-->
                                    <!--                                            <div id="516b98016fb0faf142e890e6b63db900" class="card" style="border-radius: 0px;">-->

                                    <!--                                            </div>-->
                                    <!--                                        </div>-->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- footer -->
        <footer id="footer" class="footer">
            <div class="container-fluid">
                <div class="row gutters-y align-items-center">
                    <div class="col-md-6 col-lg-5">
                        <div id="footerDiv" class="px-3 fw-400">

                        </div>
                    </div>
                </div>
            </div>
        </footer>
        <!-- /.footer -->
    </div>
</div>

<!-- jQuery -->
<script src="js/jquery.min.js"></script>
<!-- Bootstrap -->
<script src="js/bootstrap.min.js"></script>
<!-- Moment -->
<script src="plugins/lib/moment/moment.min.js"></script>
<!-- User JS -->
<script src="js/scripts.js"></script>
<!-- Main JS -->
<script src="js/main.js" id="_mainJS" data-plugins="load"></script>
<!-- Modules -->
<script src="js/modules.js"></script>

<script src="js/pagination.js"></script>
<script src="js/Decoder.js"></script>
<script src="js/YUVCanvas.js"></script>
<script src="js/Player.js"></script>
<script src="js/footer.js"></script>

<script>
    // 设备id 判断是从首页加载，还是点击设备列表
    // 从设备列表进入播放页时传入设备的id。用于判定后续切换视频模式时是否根据id加载
    // 从Pagination进入播放，从Btn进入播放时，会清空id
    var id = getQueryVariable("id");

    // 初始化播放模式
    var videoType = "VI";
    //设备url只维护单纯的ip地址，ws前缀和ws端口号用默认的
    var urlTemplate = "ws://ip:7250/";

    var pageNum = 1;
    var pageSize = 1;
    var totalCount = 0;

    var playerMap = {};
    var clientMap = {};

    //加载页面时直接进入视频播放
    generateCanvas(true, id);

    function generateCanvas(initPaginationFlag, id) {
        console.log("show " + pageSize + " canvas!");

        let path = "";
        let jsonObject = {};

        if (id === "") {
            path = apiPath + "/machine/search";
            jsonObject = {
                "pageNum": pageNum,
                "pageSize": pageSize
            };
        } else {
            path = apiPath + "/machine/searchOneList"
            jsonObject = {
                "id": id
            };
        }

        axios.post(path, jsonObject, {headers: {"gasToken": getGasToken()}}).then((res) => {
            console.log("获取监测设备list:");
            console.log(res.data.data);
            let machineList = res.data.data;

            totalCount = res.data.total;
            //判断是否重新绘制分页插件(从Btn进入需要重新绘制，从Pagination进入不需要)
            if (initPaginationFlag) {
                initPagination();
            }

            let parent = document.getElementById("video_back");
            parent.innerHTML = '';
            for (let key in playerMap) {
                let prePlayer = playerMap[key];
                let preClient = clientMap[key];
                preClient.close();
                preClient = null;
                prePlayer = null;
            }
            playerMap = {};
            clientMap = {};

            for (let i = 0; i < machineList.length; i++) {
                let machine = machineList[i];
                let machineId = machine.id;

                // 包含播放器的div id为设备id class根据pageSize决定
                let divGrid = document.createElement("div");
                divGrid.className = getCanvasDivStyle(machineList.length);
                divGrid.style.cssText = "border: 1px solid rgba(42, 242, 112, 0.2);";

                let div = document.createElement("div");
                div.id = machineId;
                div.className = "card";
                div.style.cssText = "border-radius: 0px;";
                // div.className = getCanvasDivStyle(pageSize);

                // 设备名称标签
                let divMachineName = document.createElement("div");
                divMachineName.innerText = machine.machineName;
                divMachineName.style.cssText = "position: absolute;margin-left: 10px;margin-top: 5px;color: white;z-index: 999";

                divGrid.appendChild(divMachineName);

                // canvas播放器
                let player = new Player();
                let canvas = player.canvas;
                canvas.className = "canvas"
                if (videoType === "VI") {
                    canvas.width = 1280;
                    canvas.height = 720;
                }
                if (videoType === "IR") {
                    canvas.width = 640;
                    canvas.height = 512;
                }
                div.appendChild(canvas);
                divGrid.appendChild(div);

                // 将包含播放器的divGrid加入到父div中
                parent.appendChild(divGrid);

                // 维护播放器对象、websocket连接对象
                let machineUrl = machine.machineUrl;
                try {
                    let websocketClient = new WebSocket(urlTemplate.replace("ip", machineUrl));
                    playerMap[machineId] = player;
                    clientMap[machineId] = websocketClient;
                } catch (e) {
                    console.log(e)
                }
            }

            // 如果是单个视频画面 则展示报警气体信息
            if (machineList.length === 1) {
                let div = document.createElement("div");
                div.id = "divWarningGas";
                div.className = "panel-table-gas col-md-2";
                div.scrollbar = "scroll";

                let table = document.createElement("table");
                table.className = "table table-borderless mb-0";
                let thead = document.createElement("thead");
                let colgroup = document.createElement("colgroup");
                let col1 = document.createElement("col");
                col1.style.width = "11%";
                let col2 = document.createElement("col");
                col2.style.width = "62%";
                let col3 = document.createElement("col");
                col3.style.width = "27%";
                colgroup.appendChild(col1);
                colgroup.appendChild(col2);
                colgroup.appendChild(col3);
                // thead.appendChild(colgroup);
                let tbody_1 = document.createElement("tbody");
                let tr = document.createElement("tr");
                let th = document.createElement("th");
                th.scope = "col";
                th.colSpan = 3;
                th.className = "";
                th.innerText = "报警信息";
                th.style.cssText = "border-bottom: 1px solid rgba(255, 255, 255, 0.15);";
                tr.appendChild(th);
                tbody_1.appendChild(tr)
                // thead.appendChild(tr);
                table.appendChild(thead);
                table.appendChild(colgroup);
                table.appendChild(tbody_1);
                let tbody = document.createElement("tbody");
                tbody.id = "gas-table-tbody";
                table.appendChild(tbody);
                div.appendChild(table);

                parent.appendChild(div);

                // 手动mock报警气体信息
                // assembleGasTable();
            }

            for (let key in playerMap) {
                let canvasPlayer = playerMap[key];
                let client = clientMap[key];
                client.binaryType = 'arraybuffer';
                client.onopen = function (evt) {
                    // alert("open");
                };
                client.onclose = function (evt) {
                    console.log("websocket connection closed!");
                    client.close();
                };
                client.onerror = function (evt) {
                    console.log("websocket connect error!");
                    // alert("websocket connection error!");
                };
                client.onmessage = function (evt) {
                    var b = evt.data;
                    var tag_msg = b.split('$');
                    if (tag_msg.length == 4 && tag_msg[1] == "WVideoX264VI") {
                        var tag_1 = jQuery.parseJSON(tag_msg[3]);
                        //var tag_2 = ;
                        let decode = window.atob(tag_1['Msg']['VideoData']);
                        var len = decode.length;
                        var bytes_1 = new Uint8Array(len);
                        for (var i = 0; i < len; i++) {
                            bytes_1[i] = decode.charCodeAt(i);
                        }
                        canvasPlayer.decode(bytes_1);
                    }

                    if (tag_msg.length === 4 && tag_msg[1] === "WarningMsg") {
                        let tag_1 = jQuery.parseJSON(tag_msg[3]);
                        let array = tag_1['Msg']['WarningGas'];
                        let tbody = document.getElementById("gas-table-tbody");
                        tbody.innerHTML = "";
                        if (array.length !== 0) {
                            for (let i = 0; i < array.length; i++) {
                                let gas = array[i];
                                let tr = document.createElement("tr");

                                let td1 = document.createElement("td");
                                td1.style.cursor = "pointer";
                                let span = document.createElement("span");
                                span.className = "badnge px-2 ml-1";
                                span.style.backgroundColor = "#" + gas.GasColor;
                                td1.appendChild(span);

                                let td2 = document.createElement("td");
                                td2.style.cursor = "pointer";
                                td2.style.width = "80%";
                                td2.title = gas.GasName;
                                td2.innerText = gas.GasName;

                                let td3 = document.createElement("td");
                                td3.style.cursor = "pointer";
                                td3.title = gas.GasCon;
                                td3.innerText = gas.GasCon;

                                tr.appendChild(td1);
                                tr.appendChild(td2);
                                tr.appendChild(td3);

                                tbody.appendChild(tr);
                            }
                        }
                    } else {
                        if (b === "you are connected!") {
                            console.log(b);
                            let scrible_msg =
                                'create_subscriber$WVideoX264' + videoType + '$G2021001${"Msg":{"TopicName":"WVideoX264' + videoType + '","TopicDomain":"1001","TopicSource":"G2021001"},"TimeStamp":"20210220214742"}';
                            client.send(scrible_msg);

                            // 如果是单个视频画面 则订阅报警气体信息
                            if (machineList.length === 1) {
                                let scrible_warning =
                                    'create_subscriber$WarningMsg$G2021001${"Msg":{"TopicName":"WarningMsg","TopicDomain":"1001","TopicSource":"G2021001"},"TimeStamp":"20210220214742"}';
                                client.send(scrible_warning);
                            }
                        }
                    }
                };
            }

        });

    }

    function assembleGasTable() {
        let tbody = document.getElementById("gas-table-tbody");
        tbody.innerHTML = "";

        for (let h = 0; h < 3; h++) {
            let tr = document.createElement("tr");

            let td1 = document.createElement("td");
            td1.style.cursor = "pointer";
            let span = document.createElement("span");
            span.className = "badnge px-2 ml-1";
            span.style.backgroundColor = "#" + "16711680";
            td1.appendChild(span);

            let td2 = document.createElement("td");
            td2.style.cursor = "pointer";
            td2.style.width = "80%";
            td2.title = "气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称";
            td2.innerText = "气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称气体名称";

            let td3 = document.createElement("td");
            td3.style.cursor = "pointer";
            td3.title = h + 0.00001;
            td3.innerText = h + 0.00001;

            tr.appendChild(td1);
            tr.appendChild(td2);
            tr.appendChild(td3);

            tbody.appendChild(tr);
        }
    }
</script>

<script>

    //从Pagination进入播放，pageNum根据传入参数确定，pageSize不变，将id清空
    function playPagination(num) {
        id = "";
        pageNum = num;
        generateCanvas(false, "");
    }

    //从Btn进入播放，pageNum置为1，pageSize根据传入参数确定1/4/9宫格，将id清空
    function playBtn(size) {
        id = "";
        pageNum = 1;
        pageSize = size;
        generateCanvas(true, "");
    }

    function changeVideoType() {
        let btn_type = document.getElementById("switchOutline-fie")
        videoType = btn_type.checked ? "IR" : "VI";

        generateCanvas(false, id);
    }

    function getCanvasDivStyle(pageSize) {
        let divClass;

        if (videoType === "VI") {
            if (pageSize === 1) {
                divClass = "panel-col col-md-9";
            } else if (pageSize > 1 && pageSize <= 4) {
                divClass = "panel-col col-md-6";
            } else if (pageSize > 4) {
                divClass = "panel-col col-md-4";
            }
        } else {
            if (pageSize === 1) {
                divClass = "panel-col col-md-6";
            } else if (pageSize > 1 && pageSize <= 4) {
                divClass = "panel-col col-md-6";
            } else if (pageSize > 4) {
                divClass = "panel-col col-md-4";
            }
        }

        return divClass;
    }

</script>
</body>
</html>
